# Техническое задание
## Система синхронного просмотра медиаконтента

**Версия:** 1.0
**Дата:** 22.01.2026
**Статус:** Утвержден к разработке

---

## 1. Общие положения

### 1.1 Наименование системы
Система синхронного просмотра медиаконтента (далее — Система, SyncWatch).

### 1.2 Основание для разработки
Создание платформы для синхронного просмотра видеоконтента несколькими пользователями в режиме реального времени с минимальными требованиями к инфраструктуре и отсутствием необходимости регистрации.

### 1.3 Назначение системы
Система предназначена для:
- Организации совместного просмотра медиаконтента в реальном времени
- Синхронизации состояния воспроизведения между всеми участниками
- Обеспечения текстового и голосового общения между участниками
- Работы без централизованного хранения и стриминга видео

### 1.4 Плановые сроки
- Разработка MVP: 8-12 недель
- Полная функциональность: 16-20 недель

---

## 2. Термины и определения

### 2.1 Основные понятия

**Комната (Room)** — изолированное пространство для совместного просмотра с уникальным идентификатором.

**Источник состояния (Source of Truth)** — сервер, который:
- Хранит каноническое состояние воспроизведения
- Принимает управляющие команды
- Транслирует изменения всем участникам
- НЕ воспроизводит и НЕ передает медиаконтент

**Источник медиаданных** — внешний ресурс, откуда браузер клиента получает видео:
- YouTube CDN
- VK CDN
- HTTP-сервер с файлом
- Любой доступный URL

**Хост (Host)** — пользователь, создавший комнату, обладающий правами управления воспроизведением.

**Участник (Participant)** — пользователь, присоединившийся к комнате.

**Drift (дрифт)** — расхождение между локальной позицией воспроизведения и эталонной позицией сервера.

**Серверное время (Server Timestamp)** — монотонное время сервера, используемое для расчета эталонной позиции воспроизведения.

### 2.2 Аббревиатуры

- **WS** — WebSocket
- **WebRTC** — Web Real-Time Communication
- **CDN** — Content Delivery Network
- **NAT** — Network Address Translation
- **MVP** — Minimum Viable Product
- **P2P** — Peer-to-Peer

---

## 3. Цели и задачи

### 3.1 Основные цели

1. **Синхронизация воспроизведения**
   - Минимальное расхождение между участниками (< 300мс)
   - Единое состояние для всех участников
   - Автоматическая коррекция drift

2. **Простота использования**
   - Отсутствие регистрации
   - Доступ по прямой ссылке
   - Работа в любом современном браузере

3. **Низкие требования к инфраструктуре**
   - Сервер не передает видео
   - Минимальный трафик сервера
   - Работа за NAT без проброса портов

4. **Коммуникация участников**
   - Текстовый чат в реальном времени
   - Голосовое общение через WebRTC
   - Индикация активных участников

### 3.2 Задачи системы

- Создание и управление комнатами
- Синхронизация состояния воспроизведения
- Обработка управляющих команд от хоста
- Передача сообщений чата
- Сигналинг для WebRTC соединений
- Контроль доступа к комнатам

---

## 4. Архитектура системы

### 4.1 Общая архитектура

```
┌─────────────────────────────────────────────────────────┐
│                     КЛИЕНТЫ                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │   Browser 1  │  │   Browser 2  │  │   Browser N  │  │
│  │              │  │              │  │              │  │
│  │  ┌────────┐  │  │  ┌────────┐  │  │  ┌────────┐  │  │
│  │  │ Player │  │  │  │ Player │  │  │  │ Player │  │  │
│  │  └────────┘  │  │  └────────┘  │  │  └────────┘  │  │
│  │      ▲       │  │      ▲       │  │      ▲       │  │
│  └──────┼───────┘  └──────┼───────┘  └──────┼───────┘  │
│         │                 │                 │           │
│         └─────────────────┴─────────────────┘           │
│                          │                              │
│                   Загрузка медиа                        │
│                          ▼                              │
│              ┌────────────────────┐                     │
│              │   CDN / File Host  │                     │
│              │  (YouTube, VK...)  │                     │
│              └────────────────────┘                     │
└─────────────────────────────────────────────────────────┘
                          │
                    WebSocket │
                          ▼
        ┌─────────────────────────────────────┐
        │           СЕРВЕР                    │
        │                                     │
        │  ┌──────────────────────────────┐  │
        │  │   WebSocket Gateway          │  │
        │  └──────────┬───────────────────┘  │
        │             │                       │
        │  ┌──────────▼───────────────────┐  │
        │  │   State Manager              │  │
        │  │   (Source of Truth)          │  │
        │  └──────────┬───────────────────┘  │
        │             │                       │
        │  ┌──────────▼───────────────────┐  │
        │  │   Room Manager               │  │
        │  └──────────┬───────────────────┘  │
        │             │                       │
        │  ┌──────────▼───────────────────┐  │
        │  │   WebRTC Signaling           │  │
        │  └──────────────────────────────┘  │
        │                                     │
        └─────────────────────────────────────┘
```

### 4.2 Компоненты системы

#### 4.2.1 Серверные компоненты

**WebSocket Gateway**
- Прием/отправка сообщений от клиентов
- Поддержка множественных подключений
- Роутинг сообщений к обработчикам

**State Manager** (Источник состояния)
- Хранение канонического состояния комнат
- Валидация команд управления
- Расчет эталонного времени воспроизведения
- Рассылка обновлений состояния

**Room Manager**
- Создание/удаление комнат
- Управление участниками
- Контроль прав доступа
- Автоматическая очистка пустых комнат

**WebRTC Signaling Server**
- Обмен SDP offer/answer
- Обмен ICE candidates
- Не передает аудио/видео

#### 4.2.2 Клиентские компоненты

**WebSocket Client**
- Подключение к серверу
- Отправка команд
- Прием обновлений состояния

**Playback Sync Engine**
- Синхронизация локального плеера
- Расчет drift
- Применение коррекций
- Обработка событий плеера

**Media Player Adapter**
- Абстракция над различными источниками (YouTube API, HTML5 video)
- Единый интерфейс управления
- Обработка событий воспроизведения

**Chat Client**
- Отображение сообщений
- Отправка сообщений
- История чата

**WebRTC Voice Client**
- Установка P2P соединений
- Управление аудиопотоками
- Индикация активности голоса

---

## 5. Функциональные требования

### 5.1 Управление комнатами

#### FR-1.1 Создание комнаты
**Описание:** Пользователь может создать новую комнату для просмотра.

**Сценарий:**
1. Пользователь открывает главную страницу
2. Система генерирует уникальный идентификатор комнаты
3. Пользователь становится хостом
4. Система перенаправляет на страницу комнаты

**Требования:**
- Идентификатор комнаты: 6-12 символов, читаемый формат
- Комната создается без регистрации
- URL комнаты: `/room/{roomId}`

#### FR-1.2 Присоединение к комнате
**Описание:** Пользователь может присоединиться к существующей комнате по ссылке.

**Сценарий:**
1. Пользователь переходит по ссылке `/room/{roomId}`
2. Система проверяет существование комнаты
3. Система добавляет пользователя в список участников
4. Система отправляет текущее состояние

**Требования:**
- Проверка существования комнаты
- Автоматическая генерация никнейма (Guest-XXXX)
- Возможность смены никнейма

#### FR-1.3 Покидание комнаты
**Описание:** Пользователь может покинуть комнату.

**Сценарий:**
1. Пользователь закрывает вкладку/браузер
2. WebSocket соединение разрывается
3. Сервер удаляет пользователя из комнаты
4. Если комната пустая более 5 минут — удаляется

**Требования:**
- Автоматическое удаление при разрыве соединения
- Передача прав хоста при выходе текущего хоста
- Уведомление других участников

### 5.2 Воспроизведение медиа

#### FR-2.1 Выбор источника медиа
**Описание:** Хост может выбрать источник для воспроизведения.

**Поддерживаемые источники:**
- YouTube видео (URL или ID)
- VK видео (URL)
- Прямой URL на медиафайл (MP4, WebM)
- Файл, загруженный на сервер

**Требования:**
- Валидация URL/ID
- Извлечение метаданных (длительность, название)
- Проверка доступности источника

#### FR-2.2 Управление воспроизведением
**Описание:** Хост управляет воспроизведением для всех участников.

**Команды:**
- `play` — запуск воспроизведения
- `pause` — пауза
- `seek(time)` — перемотка на позицию
- `setRate(rate)` — изменение скорости (0.5x - 2x)

**Требования:**
- Только хост может отправлять команды
- Команды обрабатываются на сервере
- Новое состояние рассылается всем участникам
- Фиксация серверного времени для каждой команды

#### FR-2.3 Синхронизация воспроизведения
**Описание:** Все участники воспроизводят видео синхронно.

**Механизм:**
1. Сервер хранит: `state`, `offset`, `serverTimestamp`, `rate`
2. Клиент рассчитывает: `T = offset + (now - serverTimestamp) * rate`
3. Клиент сравнивает `video.currentTime` с `T`
4. Применяет коррекцию при drift

**Политика коррекции:**
- `|drift| < 100мс` — без действий
- `100мс ≤ |drift| < 300мс` — плавная коррекция через playbackRate
- `|drift| ≥ 300мс` — жесткий seek

**Требования:**
- Проверка drift каждые 500мс
- Плавная коррекция не должна быть заметна пользователю
- Логирование событий синхронизации

### 5.3 Текстовый чат

#### FR-3.1 Отправка сообщений
**Описание:** Участники могут отправлять текстовые сообщения.

**Требования:**
- Максимальная длина: 500 символов
- Серверная метка времени
- Имя отправителя
- Санитизация HTML

#### FR-3.2 Отображение чата
**Описание:** Сообщения отображаются в хронологическом порядке.

**Требования:**
- Автоскролл к последнему сообщению
- Отображение времени отправки
- Выделение собственных сообщений
- История последних 100 сообщений

### 5.4 Голосовой чат

#### FR-4.1 Подключение к голосовому чату
**Описание:** Участники могут включить микрофон для голосового общения.

**Требования:**
- WebRTC P2P соединения
- Запрос доступа к микрофону
- Индикация говорящих участников
- Возможность отключения микрофона

#### FR-4.2 Сигналинг
**Описание:** Сервер обеспечивает обмен SDP/ICE данными.

**Требования:**
- Обмен через WebSocket
- Не передача аудиопотока через сервер
- STUN/TURN сервера для NAT traversal

---

## 6. Нефункциональные требования

### 6.1 Производительность

**NFR-1.1 Задержка синхронизации**
- Максимальный drift: < 300мс в 95% случаев
- Время реакции на команду: < 200мс

**NFR-1.2 Масштабируемость**
- Количество участников в комнате: до 20 человек
- Количество одновременных комнат: до 1000
- Количество сообщений/сек: до 100 на комнату

**NFR-1.3 Ресурсы сервера**
- CPU: < 50% на 100 комнат
- RAM: < 100MB на 100 комнат
- Трафик: < 10KB/сек на участника (без WebRTC)

### 6.2 Надежность

**NFR-2.1 Доступность**
- Uptime: 99% (SLA для production)
- Автоматический перезапуск при сбое

**NFR-2.2 Восстановление соединения**
- Автоматическое переподключение WebSocket
- Восстановление состояния после переподключения
- Таймаут переподключения: 30 секунд

**NFR-2.3 Обработка ошибок**
- Валидация всех входящих данных
- Логирование ошибок
- Graceful degradation при недоступности источника медиа

### 6.3 Безопасность

**NFR-3.1 Защита от злоупотреблений**
- Rate limiting: 10 команд/сек на пользователя
- Максимальная длина сообщений
- Защита от XSS в чате

**NFR-3.2 Изоляция комнат**
- Доступ только по знанию roomId
- Опциональная парольная защита
- Невозможность перехвата состояния других комнат

**NFR-3.3 Безопасность WebRTC**
- DTLS для шифрования аудио
- Валидация ICE candidates

### 6.4 Совместимость

**NFR-4.1 Браузеры**
- Chrome/Edge: последние 2 версии
- Firefox: последние 2 версии
- Safari: последние 2 версии
- Мобильные браузеры: iOS Safari, Chrome Android

**NFR-4.2 Сетевые условия**
- Работа за NAT без проброса портов
- Минимальная скорость: 1 Mbps
- Поддержка IPv4/IPv6

### 6.5 Удобство использования

**NFR-5.1 UX**
- Отзывчивый интерфейс (responsive design)
- Адаптация под мобильные устройства
- Интуитивное управление

**NFR-5.2 Локализация**
- Поддержка русского языка
- Поддержка английского языка
- Возможность расширения

---

## 7. Модель данных

### 7.1 Состояние комнаты (Room State)

```typescript
interface RoomState {
  roomId: string;              // Уникальный ID комнаты
  createdAt: number;           // Timestamp создания
  hostId: string;              // ID текущего хоста

  media: {
    type: 'youtube' | 'vk' | 'file' | 'url';
    source: string;            // URL или ID медиа
    duration: number;          // Длительность в секундах
    title?: string;            // Название
  } | null;

  playback: {
    state: 'playing' | 'paused';
    offset: number;            // Позиция в секундах на момент serverTimestamp
    serverTimestamp: number;   // Время сервера (UNIX ms)
    rate: number;              // Скорость воспроизведения (0.5 - 2.0)
  };

  participants: Map<string, Participant>;

  settings: {
    isPrivate: boolean;        // Приватная комната
    password?: string;         // Хеш пароля (если приватная)
    maxParticipants: number;   // Макс. участников (по умолчанию 20)
  };
}
```

### 7.2 Участник (Participant)

```typescript
interface Participant {
  id: string;                  // Уникальный ID клиента
  nickname: string;            // Отображаемое имя
  isHost: boolean;             // Флаг хоста
  joinedAt: number;            // Время присоединения
  lastSeen: number;            // Последняя активность

  voice: {
    enabled: boolean;          // Голосовой чат включен
    muted: boolean;            // Микрофон выключен
  };
}
```

### 7.3 Сообщение чата (ChatMessage)

```typescript
interface ChatMessage {
  id: string;                  // Уникальный ID сообщения
  roomId: string;              // ID комнаты
  senderId: string;            // ID отправителя
  senderName: string;          // Имя отправителя
  text: string;                // Текст (макс. 500 символов)
  timestamp: number;           // Серверное время
  type: 'user' | 'system';     // Тип сообщения
}
```

---

## 8. API и протоколы

### 8.1 WebSocket протокол

#### 8.1.1 Формат сообщений

Все сообщения передаются в формате JSON:

```typescript
interface WSMessage {
  type: string;                // Тип сообщения
  payload: any;                // Данные сообщения
  timestamp?: number;          // Серверное время (опционально)
}
```

#### 8.1.2 Клиент → Сервер

**Создание/присоединение к комнате**
```json
{
  "type": "join_room",
  "payload": {
    "roomId": "abc123",
    "nickname": "User123",
    "password": "hash" // опционально
  }
}
```

**Команды управления (только хост)**
```json
{
  "type": "playback_command",
  "payload": {
    "command": "play" | "pause" | "seek" | "setRate",
    "value": number // для seek и setRate
  }
}
```

**Установка медиа**
```json
{
  "type": "set_media",
  "payload": {
    "type": "youtube",
    "source": "dQw4w9WgXcQ",
    "title": "Video Title"
  }
}
```

**Отправка сообщения в чат**
```json
{
  "type": "chat_message",
  "payload": {
    "text": "Hello everyone!"
  }
}
```

**Обновление никнейма**
```json
{
  "type": "update_nickname",
  "payload": {
    "nickname": "NewName"
  }
}
```

**WebRTC сигналинг**
```json
{
  "type": "webrtc_signal",
  "payload": {
    "targetId": "client-uuid",
    "signal": {
      "type": "offer" | "answer" | "ice",
      "data": {} // SDP или ICE candidate
    }
  }
}
```

#### 8.1.3 Сервер → Клиент

**Подтверждение подключения**
```json
{
  "type": "joined",
  "payload": {
    "clientId": "your-uuid",
    "roomState": { /* RoomState */ },
    "participants": [ /* Participant[] */ ]
  },
  "timestamp": 1700000000000
}
```

**Обновление состояния воспроизведения**
```json
{
  "type": "playback_update",
  "payload": {
    "state": "playing",
    "offset": 120.5,
    "rate": 1.0
  },
  "timestamp": 1700000000000
}
```

**Новый участник**
```json
{
  "type": "participant_joined",
  "payload": {
    "participant": { /* Participant */ }
  },
  "timestamp": 1700000000000
}
```

**Участник покинул комнату**
```json
{
  "type": "participant_left",
  "payload": {
    "participantId": "client-uuid"
  },
  "timestamp": 1700000000000
}
```

**Сообщение чата**
```json
{
  "type": "chat_message",
  "payload": {
    "id": "msg-uuid",
    "senderId": "client-uuid",
    "senderName": "User123",
    "text": "Hello!",
    "type": "user"
  },
  "timestamp": 1700000000000
}
```

**Системное сообщение**
```json
{
  "type": "chat_message",
  "payload": {
    "id": "msg-uuid",
    "text": "User123 joined the room",
    "type": "system"
  },
  "timestamp": 1700000000000
}
```

**Ошибка**
```json
{
  "type": "error",
  "payload": {
    "code": "ROOM_NOT_FOUND" | "UNAUTHORIZED" | "INVALID_COMMAND",
    "message": "Room does not exist"
  }
}
```

### 8.2 HTTP API (опциональное расширение)

#### 8.2.1 REST Endpoints

**GET /api/room/:roomId/info**
- Описание: Получение информации о комнате
- Ответ: `{ exists: boolean, participantCount: number, hasPassword: boolean }`

**POST /api/room/create**
- Описание: Создание новой комнаты
- Тело: `{ nickname: string, settings?: RoomSettings }`
- Ответ: `{ roomId: string, token: string }`

**POST /api/upload**
- Описание: Загрузка медиафайла на сервер
- Тело: multipart/form-data
- Ответ: `{ fileId: string, url: string, duration: number }`

### 8.3 WebRTC Сигналинг

Обмен сообщениями через WebSocket:

1. **Инициатор** отправляет `offer` целевому клиенту
2. **Целевой клиент** отправляет `answer`
3. Оба клиента обмениваются `ICE candidates`
4. P2P соединение устанавливается напрямую

**Требования:**
- Использование STUN сервера (Google STUN)
- Опциональный TURN сервер для сложных NAT
- Шифрование через DTLS

---

## 9. Алгоритмы и логика

### 9.1 Расчет эталонной позиции

**На сервере (при команде):**
```
serverTimestamp = now()
offset = currentPosition
```

**На клиенте (непрерывно):**
```
T = offset + (now_client - serverTimestamp) * rate
```

**Коррекция времени:**
```
drift = video.currentTime - T

if |drift| < 100ms:
    // Ничего не делаем
else if 100ms ≤ |drift| < 300ms:
    // Плавная коррекция через playbackRate
    if drift > 0:
        video.playbackRate = rate * 0.95
    else:
        video.playbackRate = rate * 1.05
else:
    // Жесткая перемотка
    video.currentTime = T
    video.playbackRate = rate
```

### 9.2 Передача прав хоста

**Сценарий 1: Хост покидает комнату**
```
1. Сервер обнаруживает отключение хоста
2. Выбирается новый хост (первый по времени присоединения)
3. Обновляется поле hostId
4. Рассылается уведомление всем участникам
5. Новый хост получает права управления
```

**Сценарий 2: Явная передача прав**
```
1. Хост отправляет команду transfer_host(targetId)
2. Сервер валидирует targetId
3. Обновляется hostId = targetId
4. Рассылается уведомление
```

### 9.3 Очистка неактивных комнат

```
每ые 60 секунд:
  for each room in rooms:
    if room.participants.length == 0:
      room.emptyTime++
      if room.emptyTime > 5 минут:
        delete room
```

---

## 10. Технический стек

### 10.1 Серверная часть

**Язык и runtime:**
- Node.js 20+ / TypeScript 5+

**Фреймворк:**
- Fastify / Express.js (для HTTP)
- ws / Socket.IO (для WebSocket)

**Дополнительные библиотеки:**
- uuid — генерация ID
- zod — валидация данных
- winston — логирование

**Опциональная БД (для истории/аналитики):**
- Redis — кеш состояния комнат
- PostgreSQL — история комнат, статистика

### 10.2 Клиентская часть

**Язык:**
- TypeScript 5+

**Фреймворк:**
- React 18+ / Vue 3+ / Svelte

**Библиотеки:**
- simple-peer / peerjs — WebRTC
- YouTube IFrame API — интеграция с YouTube
- VK Video API — интеграция с VK
- dayjs — работа со временем

**UI:**
- Tailwind CSS / Material UI / shadcn/ui

**Сборка:**
- Vite / Next.js

### 10.3 Инфраструктура

**Развертывание:**
- Docker + Docker Compose
- PM2 для Node.js процессов

**Reverse Proxy:**
- Nginx / Caddy

**STUN/TURN:**
- coturn (опционально)

---

## 11. Инварианты системы

Следующие утверждения должны быть **всегда истинны**:

1. **Сервер не воспроизводит видео**
   - Сервер не декодирует медиа
   - Сервер не хранит кадры
   - Сервер не передает видеопоток

2. **Клиенты не управляют временем напрямую**
   - Любое изменение идет через сервер
   - Клиент не может напрямую изменить offset

3. **Серверное время — эталон**
   - Все расчеты базируются на serverTimestamp
   - Клиентское время используется только для вычисления delta

4. **Видео воспроизводится локально**
   - Каждый клиент загружает медиа из CDN/источника
   - Нет промежуточной передачи через сервер

5. **Только хост управляет воспроизведением**
   - Команды play/pause/seek принимаются только от hostId
   - Другие участники могут только просматривать

---

## 12. Этапы разработки

### Этап 1: MVP (8 недель)

**Цель:** Базовая функциональность синхронного просмотра

**Задачи:**
1. **Неделя 1-2: Инфраструктура**
   - Настройка WebSocket сервера
   - Базовая структура проекта
   - Room Manager и State Manager

2. **Неделя 3-4: Синхронизация воспроизведения**
   - Поддержка YouTube
   - Команды play/pause/seek
   - Алгоритм синхронизации на клиенте

3. **Неделя 5-6: Клиентский интерфейс**
   - Страница комнаты
   - Плеер с управлением
   - Список участников

4. **Неделя 7-8: Текстовый чат**
   - Отправка/получение сообщений
   - UI чата
   - Тестирование и отладка

**Результат:** Рабочий прототип с синхронизацией YouTube и чатом

### Этап 2: Расширенная функциональность (6 недель)

**Задачи:**
1. **Неделя 9-10: Поддержка других источников**
   - VK Video
   - Прямые URL (MP4, WebM)
   - Загрузка файлов на сервер

2. **Неделя 11-12: Голосовой чат**
   - WebRTC P2P соединения
   - Сигналинг через WS
   - UI управления микрофоном

3. **Неделя 13-14: Дополнительные функции**
   - Приватные комнаты с паролем
   - Передача прав хоста
   - История чата

**Результат:** Полнофункциональная система

### Этап 3: Оптимизация и масштабирование (6 недель)

**Задачи:**
1. **Неделя 15-16: Производительность**
   - Оптимизация серверного кода
   - Кеширование состояния в Redis
   - Load testing

2. **Неделя 17-18: UX и адаптивность**
   - Мобильная версия
   - Улучшение интерфейса
   - Локализация

3. **Неделя 19-20: Production готовность**
   - Логирование и мониторинг
   - Обработка ошибок
   - Документация

**Результат:** Production-ready система

---

## 13. Критерии приемки

### 13.1 Функциональные критерии

✅ **Создание и присоединение к комнатам**
- Пользователь может создать комнату без регистрации
- Пользователь может присоединиться по прямой ссылке
- Корректная обработка несуществующих комнат

✅ **Синхронизация воспроизведения**
- Drift между участниками < 300мс в 95% случаев
- Корректная обработка play/pause/seek
- Поддержка изменения скорости воспроизведения

✅ **Поддержка источников медиа**
- YouTube видео воспроизводятся корректно
- VK видео воспроизводятся корректно (если применимо)
- Прямые URL обрабатываются

✅ **Текстовый чат**
- Сообщения доставляются всем участникам
- Корректное отображение времени и автора
- Санитизация HTML

✅ **Голосовой чат** (опционально для MVP)
- P2P соединения устанавливаются
- Аудио передается в реальном времени
- Корректная работа за NAT

### 13.2 Нефункциональные критерии

✅ **Производительность**
- Время отклика на команду < 200мс
- Сервер выдерживает 100 одновременных комнат
- Клиент работает плавно на средних устройствах

✅ **Надежность**
- Автоматическое переподключение работает
- Состояние восстанавливается после разрыва
- Нет утечек памяти

✅ **Совместимость**
- Работает в Chrome, Firefox, Safari (последние версии)
- Адаптивный дизайн для мобильных устройств

✅ **Безопасность**
- Rate limiting защищает от спама
- XSS в чате предотвращен
- Изоляция комнат работает

---

## 14. Риски и ограничения

### 14.1 Технические риски

**Риск 1: Высокий drift на медленных соединениях**
- Вероятность: Средняя
- Влияние: Высокое
- Митигация: Адаптивный алгоритм коррекции, индикация качества соединения

**Риск 2: Проблемы WebRTC за сложными NAT**
- Вероятность: Средняя
- Влияние: Среднее
- Митигация: Использование TURN сервера

**Риск 3: Различия API разных источников медиа**
- Вероятность: Высокая
- Влияние: Среднее
- Митигация: Слой абстракции (Media Player Adapter)

### 14.2 Ограничения

1. **Зависимость от внешних CDN**
   - Если YouTube блокирует вставку, функциональность теряется
   - Решение: Поддержка альтернативных источников

2. **Масштабируемость WebRTC**
   - P2P не масштабируется на большое число участников
   - Решение: Ограничение до 20 участников

3. **Синхронизация не идеальна**
   - Сетевые задержки и разная производительность устройств
   - Решение: Реалистичные ожидания (< 300мс приемлемо)

---

## 15. Метрики успеха

### 15.1 Технические метрики

- **Средний drift:** < 150мс
- **Время отклика:** < 200мс (p95)
- **Uptime:** > 99%
- **Успешность подключений WebRTC:** > 90%

### 15.2 Пользовательские метрики

- **Время до первого воспроизведения:** < 5 секунд
- **Частота ошибок:** < 1% сессий
- **Удержание пользователей в комнате:** > 10 минут (средн.)

---

## 16. Дальнейшее развитие

### 16.1 Возможные расширения

- **Запись сессий:** Сохранение истории просмотров
- **Реакции:** Эмодзи-реакции в реальном времени
- **Плейлисты:** Очередь видео
- **Модерация:** Права модераторов, бан участников
- **Интеграция с другими платформами:** Twitch, Vimeo
- **Синхронизация субтитров:** Общие субтитры для всех

### 16.2 Монетизация (опционально)

- Premium комнаты с расширенными функциями
- Увеличенный лимит участников
- Приоритетная поддержка

---

## 17. Приложения

### 17.1 Глоссарий

См. раздел 2 "Термины и определения"

### 17.2 Ссылки на документацию

- [YouTube IFrame API](https://developers.google.com/youtube/iframe_api_reference)
- [WebRTC API (MDN)](https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API)
- [WebSocket API](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket)
- [HTML5 Video Element](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/video)

### 17.3 Диаграммы последовательности

#### Создание и присоединение к комнате

```
Клиент 1                Сервер                  Клиент 2
   |                       |                        |
   |-- join_room --------> |                        |
   |                       |                        |
   |<-- joined ----------- |                        |
   |   (roomState)         |                        |
   |                       |                        |
   |                       |<-- join_room ----------|
   |                       |                        |
   |<-- participant_joined |                        |
   |                       |                        |
   |                       |-- joined ------------->|
   |                       |   (roomState)          |
```

#### Управление воспроизведением

```
Хост                    Сервер              Участники
 |                         |                    |
 |-- playback_command ---> |                    |
 |   (play)                |                    |
 |                         |                    |
 |                         |-- playback_update ->|
 |                         |                    |
 |<-- playback_update ---- |                    |
 |                         |                    |
 |                      [Все синхронизируются]  |
```

---

## 18. Подписи и утверждения

**Документ подготовлен:** Системный аналитик
**Дата:** 22.01.2026

**Статус:** ✅ Утвержден к разработке

---

**Конец документа**
